<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoboSats Notifier</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="alternate icon" href="/favicon.svg">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ü§ñ RoboSats Notifier</h1>
            <p class="subtitle">Configure your notification settings and authenticate</p>
        </header>

        <!-- Status Section -->
        <section class="status-section">
            <h2>Status</h2>
            <div class="status-grid">
                <div class="status-item">
                    <span class="status-label">Bot Status:</span>
                    <div class="status-with-control">
                        <div class="status-info">
                            <span id="bot-status" class="status-value">Checking...</span>
                            <span id="next-check-time" class="next-check-time"></span>
                        </div>
                        <button type="button" id="bot-toggle-btn" class="icon-btn" title="Pause/Resume Bot" style="display: none;">
                            <svg id="pause-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="6" y="4" width="4" height="16"></rect>
                                <rect x="14" y="4" width="4" height="16"></rect>
                            </svg>
                            <svg id="play-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="status-item">
                    <span class="status-label">WhatsApp:</span>
                    <span id="whatsapp-status" class="status-value">Checking...</span>
                </div>
            </div>
        </section>

        <!-- QR Code Section -->
        <section class="qr-section" id="qr-section" style="display: none;">
            <h2>WhatsApp Authentication</h2>
            <p>Scan this QR code with your WhatsApp mobile app:</p>
            <div class="qr-container">
                <img id="qr-code" src="" alt="QR Code">
            </div>
        </section>

        <!-- Settings Form -->
        <section class="settings-section">
            <h2>Settings</h2>
            <div id="connection-warning" class="connection-warning" style="display: none;">
                ‚ö†Ô∏è Settings are disabled until WhatsApp is connected. Please scan the QR code above to continue.
            </div>
            <form id="settings-form">
                <div class="form-group">
                    <label>Notification Type</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="NOTIFICATION_TYPE" value="group">
                            <span>WhatsApp Group</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="NOTIFICATION_TYPE" value="contact">
                            <span>WhatsApp Contact</span>
                        </label>
                    </div>
                    <small>Choose where to send notifications</small>
                </div>

                <div class="form-group" id="group-name-field" style="display: none;">
                    <label for="whatsapp-group">WhatsApp Group Name</label>
                    <div style="display: flex; gap: 10px;">
                        <div class="input-wrapper" style="flex: 1; position: relative;">
                            <input type="text" id="whatsapp-group" name="WHATSAPP_GROUP_NAME" style="width: 100%;">
                            <span class="success-icon">‚úì</span>
                        </div>
                        <button type="button" id="test-message-btn" class="btn btn-test">Test</button>
                    </div>
                    <small>The exact name of your WhatsApp group</small>
                </div>

                <div class="form-group" id="contact-fields" style="display: none;">
                    <label>Phone Number</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <div class="country-selector" id="country-selector" style="flex: 0 0 250px; position: relative;">
                            <div class="country-selector-trigger">
                                <span class="country-selector-text">Select country...</span>
                                <span class="country-selector-arrow"></span>
                            </div>
                            <div class="country-selector-dropdown">
                                <input type="text" class="country-selector-search" placeholder="Search countries...">
                                <div class="country-selector-options"></div>
                            </div>
                            <span class="success-icon">‚úì</span>
                        </div>
                        <div class="input-wrapper" style="flex: 1; position: relative;">
                            <input type="text" id="contact-phone" name="CONTACT_PHONE_NUMBER" placeholder="Phone number" style="width: 100%;">
                            <span class="success-icon">‚úì</span>
                        </div>
                        <button type="button" id="test-contact-btn" class="btn btn-test">Test</button>
                    </div>
                    <input type="hidden" id="contact-country-code" name="CONTACT_COUNTRY_CODE">
                    <small>Enter phone number without country code (digits only, 6-15 characters)</small>
                </div>

                <div class="form-group">
                    <label for="check-interval">Check Interval (minutes)</label>
                    <input type="number" id="check-interval" name="CHECK_INTERVAL_MINUTES" min="1" value="5" required>
                    <small>How often to check for new offers</small>
                </div>

                <div class="form-group">
                    <label for="target-currencies">Target Currencies</label>
                    <div class="multiselect" id="currencies-multiselect">
                        <div class="multiselect-trigger">
                            <span class="multiselect-text">Select currencies...</span>
                            <span class="multiselect-arrow"></span>
                        </div>
                        <div class="multiselect-dropdown">
                            <input type="text" class="multiselect-search" placeholder="Search...">
                            <div class="multiselect-options"></div>
                        </div>
                    </div>
                    <input type="hidden" id="target-currencies" name="TARGET_CURRENCIES" required>
                    <small>Select one or more currency codes</small>
                </div>

                <div class="form-group">
                    <label for="language">Language</label>
                    <div class="multiselect" id="language-multiselect">
                        <div class="multiselect-trigger">
                            <span class="multiselect-text">Select language...</span>
                            <span class="multiselect-arrow"></span>
                        </div>
                        <div class="multiselect-dropdown">
                            <input type="text" class="multiselect-search" placeholder="Search...">
                            <div class="multiselect-options"></div>
                        </div>
                    </div>
                    <input type="hidden" id="language" name="LANGUAGE" required>
                </div>

                <!-- RoboSats API URL is auto-configured by Umbrel, no user input needed -->

                <div class="form-group">
                    <label for="robosats-coordinators">RoboSats Coordinators</label>
                    <div class="multiselect" id="coordinators-multiselect">
                        <div class="multiselect-trigger">
                            <span class="multiselect-text">Select coordinators...</span>
                            <span class="multiselect-arrow"></span>
                        </div>
                        <div class="multiselect-dropdown">
                            <input type="text" class="multiselect-search" placeholder="Search...">
                            <div class="multiselect-options"></div>
                        </div>
                    </div>
                    <input type="hidden" id="robosats-coordinators" name="ROBOSATS_COORDINATORS">
                    <small>Select one or more coordinators</small>
                </div>

                <div class="form-group">
                    <label for="robosats-onion">RoboSats Onion URL (Required)</label>
                    <input type="url" id="robosats-onion" name="ROBOSATS_ONION_URL" value="http://robosatsy56bwqn56qyadmcxkx767hnabg4mihxlmgyt6if5gnuxvzad.onion" required>
                    <small>Tor onion address for RoboSats (required for fetching offers)</small>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" disabled>Save Settings</button>
                </div>
            </form>

            <div style="margin-top: 20px; border-top: 1px solid #e5e7eb; padding-top: 20px;">
                <button type="button" id="delete-history-btn" class="btn btn-danger" style="width: 100%;">Delete Offer History</button>
                <small style="display: flex; align-items: center; gap: 6px; margin-top: 12px; color: #6b7280;">
                    <span style="font-size: 1rem;">‚ÑπÔ∏è</span>
                    Permanently delete all tracked offers. This will reset notification history.
                </small>
            </div>

            <div id="message" class="message"></div>
        </section>

        <footer>
            <p>Settings are applied immediately - no restart required!</p>
        </footer>
    </div>

    <script>
        // Multi-select component class
        class MultiSelect {
            constructor(containerId, options, selectedValues = [], singleSelect = false) {
                this.container = document.getElementById(containerId);
                // Support both simple arrays and {id, name} objects
                this.options = options;
                this.isObjectOptions = options.length > 0 && typeof options[0] === 'object';
                this.selectedValues = new Set(selectedValues);
                this.filteredOptions = [...options];
                this.singleSelect = singleSelect;
                
                this.trigger = this.container.querySelector('.multiselect-trigger');
                this.dropdown = this.container.querySelector('.multiselect-dropdown');
                this.searchInput = this.container.querySelector('.multiselect-search');
                this.optionsContainer = this.container.querySelector('.multiselect-options');
                this.textSpan = this.container.querySelector('.multiselect-text');
                
                this.init();
            }
            
            getOptionId(option) {
                return this.isObjectOptions ? option.id : option;
            }
            
            getOptionName(option) {
                return this.isObjectOptions ? option.name : option;
            }
            
            init() {
                // Ensure dropdown is closed initially
                this.dropdown.style.display = 'none';
                
                this.renderOptions();
                this.updateText();
                
                // Toggle dropdown
                this.trigger.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggleDropdown();
                });
                
                // Search functionality
                this.searchInput.addEventListener('input', (e) => {
                    this.filterOptions(e.target.value);
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!this.container.contains(e.target)) {
                        this.closeDropdown();
                    }
                });
            }
            
            renderOptions() {
                this.optionsContainer.innerHTML = '';
                
                // Add "All" option only for multi-select
                if (!this.singleSelect) {
                    const allOption = this.createOption('All', 'all', this.selectedValues.size === this.options.length);
                    this.optionsContainer.appendChild(allOption);
                }
                
                // Add regular options
                this.filteredOptions.forEach(option => {
                    const id = this.getOptionId(option);
                    const name = this.getOptionName(option);
                    const optionEl = this.createOption(name, id, this.selectedValues.has(id));
                    this.optionsContainer.appendChild(optionEl);
                });
            }
            
            createOption(label, value, checked) {
                const div = document.createElement('div');
                div.className = 'multiselect-option';
                if (value === 'all') div.classList.add('multiselect-all');
                
                const checkbox = document.createElement('input');
                checkbox.type = this.singleSelect ? 'radio' : 'checkbox';
                checkbox.checked = checked;
                checkbox.value = value;
                checkbox.name = this.singleSelect ? this.container.id + '-radio' : undefined;
                
                const labelEl = document.createElement('label');
                labelEl.textContent = label;
                
                // Make the entire div clickable, but let checkbox/radio handle their own clicks
                div.addEventListener('click', (e) => {
                    // If clicking directly on checkbox/radio, let it handle the event naturally
                    if (e.target === checkbox) {
                        return;
                    }
                    
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (this.singleSelect) {
                        // Single-select: always select (don't toggle off)
                        if (!checkbox.checked) {
                            checkbox.checked = true;
                            this.toggleOption(value, true);
                        }
                    } else {
                        // Multi-select: toggle
                        const newChecked = !checkbox.checked;
                        checkbox.checked = newChecked;
                        if (value === 'all') {
                            this.toggleAll(newChecked);
                        } else {
                            this.toggleOption(value, newChecked);
                        }
                    }
                });
                
                // Handle checkbox/radio clicks
                checkbox.addEventListener('change', (e) => {
                    e.stopPropagation();
                    
                    if (this.singleSelect) {
                        if (checkbox.checked) {
                            this.toggleOption(value, true);
                        }
                    } else {
                        if (value === 'all') {
                            this.toggleAll(checkbox.checked);
                        } else {
                            this.toggleOption(value, checkbox.checked);
                        }
                    }
                });
                
                div.appendChild(checkbox);
                div.appendChild(labelEl);
                
                return div;
            }
            
            toggleAll(checked) {
                if (checked) {
                    this.options.forEach(opt => this.selectedValues.add(this.getOptionId(opt)));
                } else {
                    this.selectedValues.clear();
                }
                this.renderOptions();
                this.updateText();
                this.onChange();
            }
            
            toggleOption(value, checked) {
                if (this.singleSelect && checked) {
                    // For single-select, clear all and set only this one
                    this.selectedValues.clear();
                    this.selectedValues.add(value);
                    this.closeDropdown();
                } else if (checked) {
                    this.selectedValues.add(value);
                } else {
                    this.selectedValues.delete(value);
                }
                this.renderOptions();
                this.updateText();
                this.onChange();
            }
            
            filterOptions(searchTerm) {
                const term = searchTerm.toLowerCase();
                this.filteredOptions = this.options.filter(opt => {
                    const searchText = this.getOptionName(opt).toLowerCase();
                    return searchText.includes(term);
                });
                this.renderOptions();
            }
            
            updateText() {
                if (this.selectedValues.size === 0) {
                    this.textSpan.textContent = this.singleSelect ? 'Select...' : 'None selected';
                } else if (this.singleSelect) {
                    // For single-select, show the selected option name
                    const selectedId = Array.from(this.selectedValues)[0];
                    const option = this.options.find(opt => this.getOptionId(opt) === selectedId);
                    this.textSpan.textContent = option ? this.getOptionName(option) : selectedId;
                } else if (this.selectedValues.size === this.options.length) {
                    this.textSpan.textContent = 'All selected';
                } else if (this.selectedValues.size <= 3) {
                    // Show friendly names instead of IDs
                    const selectedNames = Array.from(this.selectedValues).map(id => {
                        const option = this.options.find(opt => this.getOptionId(opt) === id);
                        return option ? this.getOptionName(option) : id;
                    });
                    this.textSpan.textContent = selectedNames.join(', ');
                } else {
                    this.textSpan.textContent = `${this.selectedValues.size} selected`;
                }
            }
            
            toggleDropdown() {
                this.dropdown.style.display = this.dropdown.style.display === 'block' ? 'none' : 'block';
                if (this.dropdown.style.display === 'block') {
                    this.searchInput.focus();
                }
            }
            
            closeDropdown() {
                this.dropdown.style.display = 'none';
                this.searchInput.value = '';
                this.filteredOptions = [...this.options];
                this.renderOptions();
            }
            
            getSelected() {
                return Array.from(this.selectedValues);
            }
            
            setSelected(values) {
                this.selectedValues = new Set(values);
                this.renderOptions();
                this.updateText();
            }
            
            onChange() {
                // Override this method to handle changes
            }
        }
        
        // Country selector component class
        class CountrySelector {
            constructor(containerId, countries, selectedCountryCode = null) {
                this.container = document.getElementById(containerId);
                this.countries = countries;
                this.selectedCountry = selectedCountryCode ? countries.find(c => c.dialCode === selectedCountryCode) : null;
                this.filteredCountries = [...countries];
                
                this.trigger = this.container.querySelector('.country-selector-trigger');
                this.dropdown = this.container.querySelector('.country-selector-dropdown');
                this.searchInput = this.container.querySelector('.country-selector-search');
                this.optionsContainer = this.container.querySelector('.country-selector-options');
                this.textSpan = this.container.querySelector('.country-selector-text');
                
                this.init();
            }
            
            init() {
                this.dropdown.style.display = 'none';
                this.renderOptions();
                this.updateText();
                
                this.trigger.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggleDropdown();
                });
                
                this.searchInput.addEventListener('input', (e) => {
                    this.filterCountries(e.target.value);
                });
                
                document.addEventListener('click', (e) => {
                    if (!this.container.contains(e.target)) {
                        this.closeDropdown();
                    }
                });
            }
            
            renderOptions() {
                this.optionsContainer.innerHTML = '';
                
                this.filteredCountries.forEach(country => {
                    const div = document.createElement('div');
                    div.className = 'country-option';
                    if (this.selectedCountry && this.selectedCountry.code === country.code) {
                        div.classList.add('selected');
                    }
                    
                    div.innerHTML = `
                        <span class="country-flag">${country.flag}</span>
                        <span class="country-name">${country.name}</span>
                        <span class="country-dial">${country.dialCode}</span>
                    `;
                    
                    div.addEventListener('click', () => {
                        this.selectCountry(country);
                    });
                    
                    this.optionsContainer.appendChild(div);
                });
            }
            
            selectCountry(country) {
                this.selectedCountry = country;
                this.updateText();
                this.closeDropdown();
                this.onChange();
            }
            
            filterCountries(searchTerm) {
                const term = searchTerm.toLowerCase();
                this.filteredCountries = this.countries.filter(country => {
                    return country.name.toLowerCase().includes(term) ||
                           country.code.toLowerCase().includes(term) ||
                           country.dialCode.includes(term);
                });
                this.renderOptions();
            }
            
            updateText() {
                if (this.selectedCountry) {
                    this.textSpan.innerHTML = `
                        <span class="country-flag">${this.selectedCountry.flag}</span>
                        <span>${this.selectedCountry.name} ${this.selectedCountry.dialCode}</span>
                    `;
                } else {
                    this.textSpan.textContent = 'Select country...';
                }
            }
            
            toggleDropdown() {
                this.dropdown.style.display = this.dropdown.style.display === 'block' ? 'none' : 'block';
                if (this.dropdown.style.display === 'block') {
                    this.searchInput.focus();
                }
            }
            
            closeDropdown() {
                this.dropdown.style.display = 'none';
                this.searchInput.value = '';
                this.filteredCountries = [...this.countries];
                this.renderOptions();
            }
            
            getSelected() {
                return this.selectedCountry ? this.selectedCountry.dialCode : null;
            }
            
            setSelected(dialCode) {
                this.selectedCountry = this.countries.find(c => c.dialCode === dialCode);
                this.updateText();
                this.renderOptions();
            }
            
            onChange() {
                // Override this method to handle changes
            }
        }
        
        // Global multiselect instances
        let currenciesMultiSelect;
        let coordinatorsMultiSelect;
        let languageMultiSelect;
        let countrySelector;
        
        // Bot enabled state
        let botEnabled = true;
        
        // First run state
        let isFirstRun = false;
        
        // Current notification type
        let currentNotificationType = 'group';
        
        // Original form values for change detection
        let originalFormValues = {};
        
        // Helper to show messages with auto-dismiss
        function showMessage(text, type, duration) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = `message message-${type}`;
            
            if (duration > 0) {
                setTimeout(() => {
                    messageDiv.textContent = '';
                    messageDiv.className = 'message';
                }, duration);
            }
        }
        
        // Validation helper functions
        function validateGroupName(name) {
            return name && name.trim().length > 0;
        }
        
        function validatePhoneNumber(phoneNumber) {
            if (!phoneNumber) return false;
            const clean = phoneNumber.replace(/\D/g, '');
            return clean.length >= 6 && clean.length <= 15;
        }
        
        // Success state management for inputs
        function showInputSuccess(inputElement) {
            if (!inputElement) return;
            
            // Add success class to input
            inputElement.classList.add('input-success');
            
            // Add success class to wrapper (for icon visibility)
            const wrapper = inputElement.closest('.input-wrapper');
            if (wrapper) {
                wrapper.classList.add('has-success');
            }
        }
        
        function clearInputSuccess(inputElement) {
            if (!inputElement) return;
            
            // Remove success class from input
            inputElement.classList.remove('input-success');
            
            // Remove success class from wrapper
            const wrapper = inputElement.closest('.input-wrapper');
            if (wrapper) {
                wrapper.classList.remove('has-success');
            }
        }
        
        function showCountrySelectorSuccess() {
            const countrySelector = document.getElementById('country-selector');
            if (countrySelector) {
                countrySelector.classList.add('input-success', 'has-success');
            }
        }
        
        function clearCountrySelectorSuccess() {
            const countrySelector = document.getElementById('country-selector');
            if (countrySelector) {
                countrySelector.classList.remove('input-success', 'has-success');
            }
        }
        
        // Validate all required form fields
        function validateAllFormFields() {
            const notificationType = document.querySelector('input[name="NOTIFICATION_TYPE"]:checked')?.value || 'group';
            
            // Check notification-specific fields
            if (notificationType === 'group') {
                const groupName = document.getElementById('whatsapp-group')?.value || '';
                if (!validateGroupName(groupName)) {
                    return false;
                }
            } else {
                const countryCode = countrySelector?.getSelected() || '';
                const phoneNumber = document.getElementById('contact-phone')?.value || '';
                if (!countryCode || !validatePhoneNumber(phoneNumber)) {
                    return false;
                }
            }
            
            // Check interval
            const interval = document.getElementById('check-interval')?.value;
            if (!interval || parseInt(interval) < 1) {
                return false;
            }
            
            // Check currencies
            const currencies = document.getElementById('target-currencies')?.value;
            if (!currencies || currencies.trim().length === 0) {
                return false;
            }
            
            // Check language
            const language = document.getElementById('language')?.value;
            if (!language || language.trim().length === 0) {
                return false;
            }
            
            // Check onion URL
            const onionUrl = document.getElementById('robosats-onion')?.value;
            if (!onionUrl || onionUrl.trim().length === 0) {
                return false;
            }
            
            return true;
        }
        
        // Update test button states based on input validation
        function updateTestButtonStates() {
            const groupTestBtn = document.getElementById('test-message-btn');
            const contactTestBtn = document.getElementById('test-contact-btn');
            const whatsappStatus = document.getElementById('whatsapp-status');
            const isWhatsappReady = whatsappStatus && whatsappStatus.textContent.includes('Connected');
            
            // Update group test button
            if (groupTestBtn) {
                const groupNameInput = document.getElementById('whatsapp-group');
                const groupName = groupNameInput ? groupNameInput.value : '';
                const isGroupValid = validateGroupName(groupName);
                groupTestBtn.disabled = !isWhatsappReady || !isGroupValid;
            }
            
            // Update contact test button
            if (contactTestBtn) {
                const phoneInput = document.getElementById('contact-phone');
                const phoneNumber = phoneInput ? phoneInput.value : '';
                const countryCode = countrySelector ? countrySelector.getSelected() : '';
                const isContactValid = countryCode && validatePhoneNumber(phoneNumber);
                contactTestBtn.disabled = !isWhatsappReady || !isContactValid;
            }
        }
        
        // Update bot status display and icon
        function updateBotStatusDisplay(enabled, whatsappReady) {
            const botStatus = document.getElementById('bot-status');
            const pauseIcon = document.getElementById('pause-icon');
            const playIcon = document.getElementById('play-icon');
            const toggleBtn = document.getElementById('bot-toggle-btn');
            
            botEnabled = enabled;
            
            if (!whatsappReady) {
                // WhatsApp not ready - hide button and show waiting status
                if (toggleBtn) {
                    toggleBtn.style.display = 'none';
                }
                botStatus.textContent = 'Waiting for Auth';
                botStatus.className = 'status-value status-waiting';
                return;
            }
            
            // Hide button on first run (user must save settings first)
            // Show button only after bot has been started at least once
            if (isFirstRun) {
                if (toggleBtn) {
                    toggleBtn.style.display = 'none';
                }
                botStatus.textContent = 'Not Started';
                botStatus.className = 'status-value status-paused';
                return;
            }
            
            // WhatsApp is ready and not first run - show button
            if (toggleBtn) {
                toggleBtn.style.display = '';
                toggleBtn.disabled = false;
            }
            
            if (enabled) {
                botStatus.textContent = 'Running';
                botStatus.className = 'status-value status-running';
                if (pauseIcon) pauseIcon.style.display = 'block';
                if (playIcon) playIcon.style.display = 'none';
                if (toggleBtn) toggleBtn.title = 'Pause Bot';
            } else {
                botStatus.textContent = 'Paused';
                botStatus.className = 'status-value status-paused';
                if (pauseIcon) pauseIcon.style.display = 'none';
                if (playIcon) playIcon.style.display = 'block';
                if (toggleBtn) toggleBtn.title = 'Resume Bot';
            }
            
            // Update submit button label when bot status changes
            updateSubmitButtonLabel();
        }
        
        // Toggle notification type fields visibility
        function toggleNotificationFields() {
            const checkedRadio = document.querySelector('input[name="NOTIFICATION_TYPE"]:checked');
            const notificationType = checkedRadio ? checkedRadio.value : 'group';
            currentNotificationType = notificationType;
            
            const groupField = document.getElementById('group-name-field');
            const contactFields = document.getElementById('contact-fields');
            
            if (notificationType === 'contact') {
                groupField.style.display = 'none';
                contactFields.style.display = 'block';
            } else {
                groupField.style.display = 'block';
                contactFields.style.display = 'none';
            }
            
            updateSaveButtonState();
            updateTestButtonStates();
        }
        
        // Fields to track for form changes (excludes BOT_ENABLED which is controlled separately)
        const TRACKED_FIELDS = [
            'NOTIFICATION_TYPE',
            'WHATSAPP_GROUP_NAME',
            'CONTACT_COUNTRY_CODE',
            'CONTACT_PHONE_NUMBER',
            'CHECK_INTERVAL_MINUTES', 
            'TARGET_CURRENCIES',
            'LANGUAGE',
            'ROBOSATS_COORDINATORS',
            'ROBOSATS_ONION_URL'
        ];
        
        // Get current form values (only tracked fields)
        function getCurrentFormValues() {
            const values = {};
            TRACKED_FIELDS.forEach(field => {
                const input = document.querySelector(`[name="${field}"]`);
                if (input) {
                    values[field] = (input.value || '').trim();
                }
            });
            return values;
        }
        
        // Check if form has changes
        function hasFormChanged() {
            if (Object.keys(originalFormValues).length === 0) {
                return false; // Not initialized yet
            }
            const currentValues = getCurrentFormValues();
            const changedFields = [];
            for (const field of TRACKED_FIELDS) {
                const current = currentValues[field] || '';
                const original = originalFormValues[field] || '';
                if (current !== original) {
                    changedFields.push(`${field}: "${original}" ‚Üí "${current}"`);
                }
            }
            if (changedFields.length > 0) {
                console.log('Changed fields:', changedFields);
                return true;
            }
            return false;
        }
        
        // Update save button state
        let isFormInitialized = false;
        
        // Update submit button label based on state
        function updateSubmitButtonLabel() {
            const saveBtn = document.querySelector('button[type="submit"]');
            if (!saveBtn) return;
            
            // If first run, show full label
            // If bot is paused, show "Save Settings and Start Bot"
            // If bot is running, show "Save & Restart"
            if (isFirstRun) {
                saveBtn.textContent = 'Save Settings and Start Bot';
            } else if (!botEnabled) {
                saveBtn.textContent = 'Save Settings and Start Bot';
            } else {
                saveBtn.textContent = 'Save & Restart';
            }
        }
        
        function updateSaveButtonState() {
            if (!isFormInitialized) {
                console.log('Form not initialized yet, skipping updateSaveButtonState');
                return;
            }
            const saveBtn = document.querySelector('button[type="submit"]');
            if (saveBtn) {
                const hasChanges = hasFormChanged();
                const isValid = validateAllFormFields();
                
                console.log('updateSaveButtonState called, hasChanges:', hasChanges, 'isValid:', isValid, 'isFirstRun:', isFirstRun);
                
                // Enable button if:
                // 1. On first run and all fields are valid (allow initial configuration)
                // 2. Not first run, has changes, and all fields are valid
                if (isFirstRun || !botEnabled) {
                    // First run or bot paused - enable if valid (ignore changes)
                    saveBtn.disabled = !isValid;
                } else {
                    // Normal operation - enable if has changes AND valid
                    saveBtn.disabled = !hasChanges || !isValid;
                }
                
                // Update label whenever state changes
                updateSubmitButtonLabel();
            }
        }
        
        // Load current settings
        async function loadSettings() {
            // Prevent reloading if already initialized (to avoid resetting form state)
            if (isFormInitialized) {
                console.log('Form already initialized, skipping loadSettings');
                return;
            }
            
            try {
                const response = await fetch('/api/settings');
                const settings = await response.json();
                
                // Load BOT_ENABLED separately (not a form field anymore)
                if (settings.BOT_ENABLED !== undefined) {
                    botEnabled = settings.BOT_ENABLED !== 'false' && settings.BOT_ENABLED !== false;
                }
                
                // Load IS_FIRST_RUN flag
                if (settings.IS_FIRST_RUN !== undefined) {
                    isFirstRun = settings.IS_FIRST_RUN === true || settings.IS_FIRST_RUN === 'true';
                }
                
                Object.keys(settings).forEach(key => {
                    const input = document.querySelector(`[name="${key}"]`);
                    if (input && settings[key] !== undefined && key !== 'BOT_ENABLED') {
                        if (input.type === 'checkbox') {
                            input.checked = settings[key] !== 'false' && settings[key] !== false;
                        } else if (key !== 'TARGET_CURRENCIES' && key !== 'ROBOSATS_COORDINATORS' && key !== 'LANGUAGE' && key !== 'NOTIFICATION_TYPE') {
                            // Skip NOTIFICATION_TYPE - radio buttons are handled separately below
                            // Don't pre-fill group name and phone number - keep them empty by default
                            if (key === 'WHATSAPP_GROUP_NAME' || key === 'CONTACT_PHONE_NUMBER') {
                                // Leave empty - user should enter these manually
                                input.value = '';
                            } else {
                                input.value = settings[key];
                            }
                        }
                    }
                });
                
                // Load currencies multiselect
                const currencies = await fetch('/api/currencies').then(r => r.json());
                const selectedCurrencies = settings.TARGET_CURRENCIES ? settings.TARGET_CURRENCIES.split(',').map(c => c.trim()) : [];
                currenciesMultiSelect = new MultiSelect('currencies-multiselect', currencies, selectedCurrencies);
                currenciesMultiSelect.onChange = () => {
                    document.getElementById('target-currencies').value = currenciesMultiSelect.getSelected().join(',');
                    updateSaveButtonState();
                };
                document.getElementById('target-currencies').value = currenciesMultiSelect.getSelected().join(',');
                
                // Load coordinators multiselect
                const coordinators = await fetch('/api/coordinators').then(r => r.json());
                const selectedCoordinators = settings.ROBOSATS_COORDINATORS ? settings.ROBOSATS_COORDINATORS.split(',').map(c => c.trim()) : [];
                coordinatorsMultiSelect = new MultiSelect('coordinators-multiselect', coordinators, selectedCoordinators);
                coordinatorsMultiSelect.onChange = () => {
                    document.getElementById('robosats-coordinators').value = coordinatorsMultiSelect.getSelected().join(',');
                    updateSaveButtonState();
                };
                document.getElementById('robosats-coordinators').value = coordinatorsMultiSelect.getSelected().join(',');
                
                // Load language multiselect (single-select mode)
                const languages = [
                    { id: 'EN', name: 'English' },
                    { id: 'ES', name: 'Spanish' }
                ];
                const selectedLanguage = settings.LANGUAGE ? [settings.LANGUAGE] : [];
                languageMultiSelect = new MultiSelect('language-multiselect', languages, selectedLanguage, true);
                languageMultiSelect.onChange = () => {
                    const selected = languageMultiSelect.getSelected();
                    document.getElementById('language').value = selected.length > 0 ? selected[0] : '';
                    updateSaveButtonState();
                };
                document.getElementById('language').value = languageMultiSelect.getSelected()[0] || '';
                
                // Load country selector (don't pre-select - keep empty by default)
                const countries = await fetch('/api/countries').then(r => r.json());
                // Don't pre-select country code - leave empty by default
                countrySelector = new CountrySelector('country-selector', countries, null);
                countrySelector.onChange = () => {
                    document.getElementById('contact-country-code').value = countrySelector.getSelected() || '';
                    updateSaveButtonState();
                    updateTestButtonStates();
                    // Clear success state when country changes
                    clearCountrySelectorSuccess();
                };
                // Don't set contact-country-code - keep it empty
                
                // Initial test button state update
                updateTestButtonStates();
                
                // Set notification type radio buttons
                const notificationType = settings.NOTIFICATION_TYPE || 'group';
                const allRadios = document.querySelectorAll('input[name="NOTIFICATION_TYPE"]');
                
                // First, uncheck all radios, then check the correct one
                allRadios.forEach(radio => {
                    radio.checked = (radio.value === notificationType);
                });
                
                // Add notification type change listeners BEFORE calling toggle
                allRadios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        toggleNotificationFields();
                    });
                });
                
                // Initialize field visibility
                toggleNotificationFields();
                
                // Store original values for change detection (now that all fields are populated)
                originalFormValues = getCurrentFormValues();
                console.log('Original form values captured:', originalFormValues);
                
                // Mark form as initialized
                isFormInitialized = true;
                
                // Initial button state
                updateSaveButtonState();
                
                // Add phone number validation
                const phoneInput = document.getElementById('contact-phone');
                phoneInput.addEventListener('input', (e) => {
                    // Allow only digits, spaces, dashes, and parentheses for formatting
                    e.target.value = e.target.value.replace(/[^\d\s\-()]/g, '');
                    updateSaveButtonState();
                    updateTestButtonStates();
                    // Clear success state when value changes
                    clearInputSuccess(e.target);
                });
                
                // Add group name input listener for test button validation
                const groupNameInput = document.getElementById('whatsapp-group');
                if (groupNameInput) {
                    groupNameInput.addEventListener('input', (e) => {
                        updateTestButtonStates();
                        // Clear success state when value changes
                        clearInputSuccess(e.target);
                    });
                }
                
                // Add change listeners to form inputs
                const form = document.getElementById('settings-form');
                form.querySelectorAll('input:not([type="hidden"]), select').forEach(input => {
                    input.addEventListener('change', updateSaveButtonState);
                    if (input.type === 'text' || input.type === 'url' || input.type === 'number') {
                        input.addEventListener('input', updateSaveButtonState);
                    }
                });
                
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Enable/disable form based on WhatsApp connection status
        function setFormEnabled(enabled) {
            const form = document.getElementById('settings-form');
            // Exclude notification type radio buttons - they should always be enabled
            const inputs = form.querySelectorAll('input:not([type="checkbox"]):not([name="NOTIFICATION_TYPE"]), select, .multiselect-trigger');
            const submitBtn = form.querySelector('button[type="submit"]');
            const testBtn = document.getElementById('test-message-btn');
            const warning = document.getElementById('connection-warning');
            
            // Show/hide connection warning
            if (warning) {
                warning.style.display = enabled ? 'none' : 'block';
            }
            
            inputs.forEach(input => {
                if (enabled) {
                    input.removeAttribute('disabled');
                    input.style.opacity = '1';
                    input.style.cursor = '';
                } else {
                    input.setAttribute('disabled', 'disabled');
                    input.style.opacity = '0.5';
                    input.style.cursor = 'not-allowed';
                }
            });
            
            // Handle multiselect dropdowns
            const multiselects = document.querySelectorAll('.multiselect');
            multiselects.forEach(ms => {
                if (enabled) {
                    ms.style.pointerEvents = '';
                    ms.style.opacity = '1';
                } else {
                    ms.style.pointerEvents = 'none';
                    ms.style.opacity = '0.5';
                }
            });
            
            // Don't modify submit button here - it's controlled by form change detection
            // Only disable it when form is disabled, but let change detection enable it
            if (submitBtn && !enabled) {
                submitBtn.disabled = true;
            } else if (submitBtn && enabled && isFormInitialized) {
                // Let change detection handle the enabled state
                updateSaveButtonState();
            }
            
            if (testBtn) {
                testBtn.disabled = !enabled;
            }
            
        }
        
        // Backend-synced countdown timer
        let countdownInterval = null;
        let nextCheckTimestamp = null; // Timestamp (ms) when next check will occur
        let lastSyncAttempt = 0;
        const SYNC_INTERVAL = 5000; // Sync every 5 seconds to catch backend cycles
        
        // Fetch latest nextCheckTime from backend
        async function syncNextCheckTime() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();
                
                if (status.nextCheckTime) {
                    nextCheckTimestamp = status.nextCheckTime;
                    lastSyncAttempt = Date.now();
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Error syncing countdown:', error);
                return false;
            }
        }
        
        // Update countdown display (pure client-side calculation)
        async function renderCountdown() {
            const nextCheckTimeEl = document.getElementById('next-check-time');
            if (!nextCheckTimeEl) return;
            
            // Hide if paused or no timestamp
            if (!botEnabled || !nextCheckTimestamp) {
                nextCheckTimeEl.textContent = '';
                return;
            }
            
            // Calculate seconds remaining
            const now = Date.now();
            let secondsRemaining = Math.max(0, Math.ceil((nextCheckTimestamp - now) / 1000));
            
            // If countdown hit 0 or near 0, sync with backend to get new cycle time
            if (secondsRemaining <= 1) {
                // Only sync if we haven't synced recently (avoid spam)
                if (now - lastSyncAttempt > 2000) {
                    console.log('Countdown reached 0, syncing with backend...');
                    await syncNextCheckTime();
                    // Recalculate after sync
                    secondsRemaining = Math.max(0, Math.ceil((nextCheckTimestamp - now) / 1000));
                }
            }
            
            // Periodic sync to catch backend cycles
            if (now - lastSyncAttempt > SYNC_INTERVAL) {
                syncNextCheckTime();
            }
            
            // Format time as MM:SS
            const minutes = Math.floor(secondsRemaining / 60);
            const seconds = secondsRemaining % 60;
            const timeStr = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
            nextCheckTimeEl.textContent = `Next check in ${timeStr}`;
        }
        
        // Start countdown timer - renders every second based on backend timestamp
        async function startCountdownTimer(initialTimestamp) {
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            // Fetch fresh timestamp if not provided
            if (initialTimestamp) {
                nextCheckTimestamp = initialTimestamp;
                lastSyncAttempt = Date.now();
            } else {
                await syncNextCheckTime();
            }
            
            // Render immediately
            await renderCountdown();
            
            // Update display every second
            countdownInterval = setInterval(async () => {
                await renderCountdown();
            }, 1000);
        }
        
        // Stop countdown timer
        function stopCountdownTimer() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            nextCheckTimestamp = null;
            renderCountdown();
        }
        
        // Load bot status
        async function loadStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();
                
                const whatsappStatus = document.getElementById('whatsapp-status');
                
                if (status.isReady) {
                    updateBotStatusDisplay(botEnabled, true);
                    whatsappStatus.textContent = 'Connected';
                    whatsappStatus.className = 'status-value status-running';
                    document.getElementById('qr-section').style.display = 'none';
                    setFormEnabled(true);
                    updateTestButtonStates();
                    
                    // Start countdown timer if bot is enabled and we have a timestamp
                    if (botEnabled && status.nextCheckTime) {
                        startCountdownTimer(status.nextCheckTime);
                    }
                } else if (status.qrData) {
                    const botStatus = document.getElementById('bot-status');
                    botStatus.textContent = 'Waiting for Auth';
                    updateTestButtonStates();
                    botStatus.className = 'status-value status-waiting';
                    whatsappStatus.textContent = 'Scan QR Code';
                    whatsappStatus.className = 'status-value status-waiting';
                    document.getElementById('qr-section').style.display = 'block';
                    document.getElementById('qr-code').src = status.qrData;
                    setFormEnabled(false);
                    updateBotStatusDisplay(botEnabled, false);
                    nextCheckTimestamp = null;
                    renderCountdown();
                } else {
                    const botStatus = document.getElementById('bot-status');
                    botStatus.textContent = 'Initializing';
                    botStatus.className = 'status-value status-waiting';
                    whatsappStatus.textContent = 'Initializing';
                    whatsappStatus.className = 'status-value status-waiting';
                    setFormEnabled(false);
                    updateBotStatusDisplay(botEnabled, false);
                    nextCheckTimestamp = null;
                    renderCountdown();
                }
            } catch (error) {
                console.error('Error loading status:', error);
                document.getElementById('bot-status').textContent = 'Error';
                document.getElementById('whatsapp-status').textContent = 'Error';
                setFormEnabled(false);
            }
        }

        // Setup Server-Sent Events for real-time QR code updates
        function setupSSE() {
            const eventSource = new EventSource('/api/qr-events');
            
            eventSource.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                if (data.qrData) {
                    document.getElementById('qr-section').style.display = 'block';
                    document.getElementById('qr-code').src = data.qrData;
                    document.getElementById('whatsapp-status').textContent = 'Scan QR Code';
                    document.getElementById('whatsapp-status').className = 'status-value status-waiting';
                    setFormEnabled(false);
                    updateBotStatusDisplay(botEnabled, false);
                    updateTestButtonStates();
                }
                
                if (data.authenticated || data.ready) {
                    document.getElementById('qr-section').style.display = 'none';
                    document.getElementById('whatsapp-status').textContent = 'Connected';
                    document.getElementById('whatsapp-status').className = 'status-value status-running';
                    if (data.ready) {
                        updateBotStatusDisplay(botEnabled, true);
                        setFormEnabled(true);
                        updateTestButtonStates();
                    }
                }
            };
            
            eventSource.onerror = (error) => {
                console.error('SSE error:', error);
            };
        }

        // Save settings
        document.getElementById('settings-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            const nextCheckTimeEl = document.getElementById('next-check-time');
            
            // Helper to restore UI state on failure/validation error
            function restoreUIState() {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                // Restore countdown display if bot is enabled
                if (botEnabled && nextCheckTimestamp) {
                    renderCountdown();
                }
            }
            
            // Show loading state
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';
            if (nextCheckTimeEl) nextCheckTimeEl.textContent = ''; // Hide countdown during save
            
            const formData = new FormData(e.target);
            const settings = Object.fromEntries(formData.entries());
            
            // Validate notification settings
            const notificationType = settings.NOTIFICATION_TYPE || 'group';
            
            if (notificationType === 'contact') {
                // Validate contact settings
                const countryCode = countrySelector.getSelected();
                const phoneNumber = settings.CONTACT_PHONE_NUMBER?.trim();
                
                if (!countryCode) {
                    showMessage('Please select a country code', 'error', 10000);
                    restoreUIState();
                    return;
                }
                
                if (!phoneNumber) {
                    showMessage('Please enter a phone number', 'error', 10000);
                    restoreUIState();
                    return;
                }
                
                // Validate phone number format
                const cleanPhone = phoneNumber.replace(/\D/g, '');
                if (cleanPhone.length < 6 || cleanPhone.length > 15) {
                    showMessage('Phone number must be 6-15 digits', 'error', 10000);
                    restoreUIState();
                    return;
                }
                
                // Ensure country code is included in settings
                settings.CONTACT_COUNTRY_CODE = countryCode;
            } else {
                // Validate group settings
                if (!settings.WHATSAPP_GROUP_NAME?.trim()) {
                    showMessage('Please enter a WhatsApp group name', 'error', 10000);
                    restoreUIState();
                    return;
                }
            }
            
            // Clean up opposite notification type's fields
            if (notificationType === 'contact') {
                // Delete group name when switching to contact
                delete settings.WHATSAPP_GROUP_NAME;
            } else {
                // Delete contact fields when switching to group
                delete settings.CONTACT_COUNTRY_CODE;
                delete settings.CONTACT_PHONE_NUMBER;
            }
            
            // Handle BOT_ENABLED based on current state
            // If first run or bot is paused, save will start the bot
            // Otherwise, preserve current BOT_ENABLED state
            if (isFirstRun || !botEnabled) {
                // User clicked "Start Bot" - enable the bot
                settings.BOT_ENABLED = 'true';
            } else {
                // User clicked "Save & Restart" - keep bot enabled
                settings.BOT_ENABLED = 'true';
            }
            
            let saveSucceeded = false;
            
            try {
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    saveSucceeded = true;
                    showMessage(result.message, 'success', 5000);
                    
                    // After first save, no longer first run
                    if (isFirstRun) {
                        isFirstRun = false;
                    }
                    
                    // Bot is now enabled after save
                    botEnabled = true;
                    
                    // Fetch updated status to get new nextCheckTime after config change
                    const statusResponse = await fetch('/api/status');
                    const newStatus = await statusResponse.json();
                    
                    // Update bot status display
                    updateBotStatusDisplay(true, true);
                    
                    // Restart countdown timer with new timestamp
                    if (newStatus.nextCheckTime) {
                        startCountdownTimer(newStatus.nextCheckTime);
                    }
                    
                    // Clear opposite notification type's fields in the UI after successful save
                    if (notificationType === 'contact') {
                        // Clear group name field
                        const groupNameInput = document.getElementById('whatsapp-group');
                        if (groupNameInput) {
                            groupNameInput.value = '';
                        }
                    } else {
                        // Clear contact fields
                        const contactPhoneInput = document.getElementById('contact-phone');
                        const contactCountryCodeInput = document.getElementById('contact-country-code');
                        if (contactPhoneInput) {
                            contactPhoneInput.value = '';
                        }
                        if (contactCountryCodeInput) {
                            contactCountryCodeInput.value = '';
                        }
                        // Reset country selector
                        if (countrySelector) {
                            countrySelector.selectedCountry = null;
                            countrySelector.updateText();
                        }
                    }
                    
                    // Update original values after successful save
                    originalFormValues = getCurrentFormValues();
                    console.log('Original form values updated after save:', originalFormValues);
                    updateSaveButtonState();
                } else {
                    showMessage(result.error || 'Failed to save settings', 'error', 10000);
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                showMessage('Error saving settings', 'error', 10000);
            } finally {
                // Restore button state
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                
                // Restore countdown if save failed and bot is running
                if (!saveSucceeded && botEnabled && nextCheckTimestamp) {
                    renderCountdown();
                }
            }
        });

        // Test message button (for group)
        document.getElementById('test-message-btn').addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            const btn = document.getElementById('test-message-btn');
            const originalText = btn.textContent;
            const groupNameInput = document.getElementById('whatsapp-group');
            const groupName = groupNameInput.value.trim();
            
            if (!groupName) {
                showMessage('Please enter a group name first', 'error', 10000);
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'Sending...';
            
            try {
                const response = await fetch('/api/test-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        notificationType: 'group',
                        groupName: groupName 
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showMessage(result.message, 'success', 5000);
                    
                    // Show success feedback on input field
                    showInputSuccess(groupNameInput);
                    
                    // Restore button
                    btn.disabled = false;
                    btn.textContent = originalText;
                    updateTestButtonStates();
                } else {
                    showMessage(result.error || 'Failed to send test message', 'error', 10000);
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            } catch (error) {
                console.error('Error sending test message:', error);
                showMessage('Error sending test message', 'error', 10000);
                btn.disabled = false;
                btn.textContent = originalText;
            }
        });

        // Test contact button
        document.getElementById('test-contact-btn').addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            const btn = document.getElementById('test-contact-btn');
            const originalText = btn.textContent;
            const countryCode = countrySelector.getSelected();
            const phoneNumber = document.getElementById('contact-phone').value.trim();
            
            if (!countryCode) {
                showMessage('Please select a country code first', 'error', 10000);
                return;
            }
            
            if (!phoneNumber) {
                showMessage('Please enter a phone number', 'error', 10000);
                return;
            }
            
            // Validate phone number
            const cleanPhone = phoneNumber.replace(/\D/g, '');
            if (cleanPhone.length < 6 || cleanPhone.length > 15) {
                showMessage('Phone number must be 6-15 digits', 'error', 10000);
                return;
            }
            
            btn.disabled = true;
            btn.textContent = 'Sending...';
            
            try {
                const response = await fetch('/api/test-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        notificationType: 'contact',
                        countryCode: countryCode,
                        phoneNumber: phoneNumber
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showMessage(result.message, 'success', 5000);
                    
                    // Show success feedback on country selector and phone input
                    const phoneInput = document.getElementById('contact-phone');
                    showCountrySelectorSuccess();
                    showInputSuccess(phoneInput);
                    
                    // Restore button
                    btn.disabled = false;
                    btn.textContent = originalText;
                    updateTestButtonStates();
                } else {
                    showMessage(result.error || 'Failed to send test message', 'error', 10000);
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            } catch (error) {
                console.error('Error sending test message:', error);
                showMessage('Error sending test message', 'error', 10000);
                btn.disabled = false;
                btn.textContent = originalText;
            }
        });

        // Bot toggle button (pause/resume)
        document.getElementById('bot-toggle-btn').addEventListener('click', async () => {
            const btn = document.getElementById('bot-toggle-btn');
            btn.disabled = true;
            btn.classList.add('loading');
            
            try {
                const newState = !botEnabled;
                
                // Only send BOT_ENABLED to avoid overwriting unsaved form changes
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ BOT_ENABLED: newState ? 'true' : 'false' })
                });
                
                if (response.ok) {
                    updateBotStatusDisplay(newState, true);
                    
                    // Start/stop countdown timer based on new state
                    if (newState) {
                        // Bot resumed - show estimated countdown immediately
                        // Use check interval from form to estimate next check time
                        const checkIntervalMinutes = parseInt(document.getElementById('check-interval').value) || 5;
                        const estimatedNextCheck = Date.now() + (checkIntervalMinutes * 60 * 1000);
                        startCountdownTimer(estimatedNextCheck);
                        
                        // Sync with actual backend time after a short delay
                        setTimeout(async () => {
                            const statusResponse = await fetch('/api/status');
                            const status = await statusResponse.json();
                            if (status.nextCheckTime) {
                                nextCheckTimestamp = status.nextCheckTime;
                            }
                        }, 2000);
                    } else {
                        // Bot paused - stop countdown timer
                        stopCountdownTimer();
                    }
                    
                    showMessage(newState ? 'Bot resumed' : 'Bot paused', 'success', 3000);
                } else {
                    const result = await response.json();
                    showMessage(result.error || 'Failed to toggle bot', 'error', 5000);
                }
            } catch (error) {
                console.error('Error toggling bot:', error);
                showMessage('Error toggling bot', 'error', 5000);
            } finally {
                btn.disabled = false;
                btn.classList.remove('loading');
            }
        });
        
        // Delete offer history button
        document.getElementById('delete-history-btn').addEventListener('click', async () => {
            // Confirmation dialog
            const confirmed = confirm(
                '‚ö†Ô∏è WARNING: Delete Offer History\n\n' +
                'This will permanently delete all tracked offers.\n' +
                'After deletion, ALL offers will be treated as new and may trigger notifications again.\n\n' +
                'Are you sure you want to continue?'
            );
            
            if (!confirmed) {
                return;
            }
            
            const btn = document.getElementById('delete-history-btn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Deleting...';
            
            try {
                const response = await fetch('/api/delete-history', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showMessage(result.message || 'Offer history deleted successfully!', 'success', 5000);
                } else {
                    showMessage(result.error || 'Failed to delete history', 'error', 5000);
                }
            } catch (error) {
                console.error('Error deleting history:', error);
                showMessage('Error deleting history', 'error', 5000);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        });
        
        // Initialize
        loadSettings();
        loadStatus();
        setupSSE();
        
        // Refresh status every 10 seconds
        setInterval(loadStatus, 10000);
    </script>
</body>
</html>
